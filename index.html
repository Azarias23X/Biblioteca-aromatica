<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Biblioteca Olfativa</title>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 92%;
      max-width: 920px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    h1 {
      text-align: center;
      color: #333;
      margin: 0 0 18px;
      padding: 0 36px;
      line-height: 1.2;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px;
    }

    form input,
    form textarea {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
      width: 100%;
    }

    form textarea {
      resize: vertical;
      min-height: 84px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
      width: 100%;
    }

    form button {
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
    }

    form button:hover {
      background-color: #45a049;
    }

    .tool-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95rem;
      color: #fff;
      background: #111;
      white-space: nowrap;
    }

    .tool-btn.primary {
      background: #007BFF;
    }

    .tool-btn.secondary {
      background: #6c757d;
    }

    .tool-btn:hover {
      opacity: 0.92;
    }

    /* ✅ Título + Orden a la derecha */
    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0 10px;
      flex-wrap: wrap;
    }

    .list-header h2 {
      margin: 0;
      font-size: 1.08rem;
    }

    /* ✅ Sort dropdown */
    .sort-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .sort-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      z-index: 1600;
      overflow: hidden;
      display: none;
      min-width: 220px;
      max-width: calc(100vw - 40px);
    }

    .sort-menu.open {
      display: block;
    }

    .sort-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
      white-space: nowrap;
    }

    .sort-item:last-child {
      border-bottom: none;
    }

    .sort-item:hover {
      background: #f6f7f9;
    }

    /* ✅ Search bar arriba de la tabla */
    #tableSearchBar {
      background: #EEF2FF;
      border: 1px solid #E0E7FF;
      border-radius: 14px;
      padding: 12px;
      margin: 8px 0 12px;
    }

    .search-wrap {
      position: relative;
      width: 100%;
    }

    #search {
      padding: 10px 40px 10px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      font-size: 1rem;
      width: 100%;
      outline: none;
      background: #fff;
    }

    #search:focus {
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #111;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
    }

    .clear-btn:hover {
      opacity: 0.92;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      font-size: 0.92rem;
      min-width: 620px;
    }

    table thead {
      background-color: #f5f5f5;
    }

    table th,
    table td {
      text-align: left;
      padding: 7px 8px;
      border: 1px solid #ddd;
      vertical-align: middle;
      white-space: nowrap;
    }

    /* ✅ Columna Lugar más chica + ellipsis */
    table th:nth-child(3),
    table td:nth-child(3) {
      width: 140px;
      max-width: 140px;
    }

    table td:nth-child(3) {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table th {
      font-size: 0.9rem;
      position: relative;
    }

    table tr:hover {
      background-color: #f9f9f9;
    }

    .stock-button {
      padding: 5px 9px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .stock-available {
      background-color: #4CAF50;
    }

    .stock-low {
      background-color: #FFC107;
      color: #111;
    }

    .stock-out {
      background-color: #F44336;
    }

    .next-button {
      position: absolute;
      top: 12px;
      right: 12px;
      background-color: transparent;
      color: #007bff;
      border: none;
      cursor: pointer;
      font-size: 1.35rem;
      padding: 6px 10px;
      border-radius: 10px;
    }

    .next-button:hover {
      color: #0056b3;
      background: #f3f4f6;
    }

    .row-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 5px 9px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .btn-edit {
      background-color: #6c757d;
      color: white;
    }

    .btn-save {
      background-color: #198754;
      color: white;
    }

    .btn-cancel {
      background-color: #adb5bd;
      color: #111;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .edit-input {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 0.92rem;
    }

    .suggest-wrap {
      position: relative;
      width: 100%;
      min-width: 0;
    }

    .suggest-list {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      z-index: 1200;
      max-height: 220px;
      overflow: auto;
      display: none;
    }

    .suggest-list.open {
      display: block;
    }

    .suggest-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .suggest-item:last-child {
      border-bottom: none;
    }

    .suggest-item:hover {
      background: #f6f7f9;
    }

    .suggest-empty {
      padding: 10px 12px;
      color: #666;
      font-style: italic;
    }

    .note-toggle {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      width: 100%;
    }

    .note-btn {
      flex: 1 1 0;
      min-width: 0;
      border: 1px solid #d0d5dd;
      background: #f2f4f7;
      color: #111;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      user-select: none;
      white-space: nowrap;
    }

    .note-btn.active {
      border-color: rgba(0, 0, 0, 0.12);
    }

    .note-salida.active {
      background: #FFF2C6;
      color: #5a4200;
    }

    .note-corazon.active {
      background: #DCEBFF;
      color: #0b2b5a;
    }

    .note-fondo.active {
      background: #E8D7C5;
      color: #3c2415;
    }

    .multi-select {
      position: relative;
      width: 100%;
    }

    .multi-select-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.2;
      text-align: left;
      min-width: 0;
    }

    .multi-select-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      width: 100%;
      min-height: 20px;
      min-width: 0;
    }

    .multi-select-placeholder {
      width: 100%;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      user-select: none;
      white-space: nowrap;
      max-width: 100%;
    }

    .chip .x {
      font-weight: bold;
      cursor: pointer;
      opacity: 0.8;
    }

    .chip .x:hover {
      opacity: 1;
    }

    .multi-select-panel {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      padding: 10px;
      z-index: 50;
      max-height: 260px;
      overflow: auto;
      display: none;
    }

    .multi-select-panel.open {
      display: block;
    }

    .family-option {
      display: grid;
      grid-template-columns: 16px 22px 1fr;
      align-items: center;
      column-gap: 10px;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      text-align: left;
    }

    .family-option:hover {
      background: #f6f7f9;
    }

    .family-swatch {
      width: 14px;
      height: 14px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.15);
    }

    .family-option input {
      margin: 0;
      width: 18px;
      height: 18px;
      justify-self: start;
    }

    .family-option span {
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .th-clickable {
      cursor: pointer;
      user-select: none;
    }

    .th-caret {
      font-weight: 900;
      margin-left: 6px;
      opacity: 0.7;
    }

    /* ✅ Dropdown Lugar más compacto */
    .th-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 200px;
      max-width: calc(100vw - 40px);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      z-index: 1500;
      overflow: hidden;
      display: none;
      max-height: 260px;
    }

    .th-menu.open {
      display: block;
    }

    .th-menu-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .th-menu-item:last-child {
      border-bottom: none;
    }

    .th-menu-item:hover {
      background: #f6f7f9;
    }

    .name-link {
      color: #0d6efd;
      cursor: pointer;
      text-decoration: underline;
      white-space: nowrap;
    }

    .name-link:hover {
      color: #0a58ca;
    }

    .json-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      width: min(680px, 96vw);
      max-height: 90vh;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }

    .modal-title {
      margin: 0;
      font-size: 1.15rem;
      color: #111;
      word-break: break-word;
    }

    .provider-line {
      margin-top: 2px;
      color: #555;
      font-size: 0.92rem;
      word-break: break-word;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.6rem;
      cursor: pointer;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 10px;
      flex: 0 0 auto;
    }

    .modal-close:hover {
      background: #f3f4f6;
    }

    .modal-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
    }

    .meta-line {
      color: #555;
      font-size: 0.92rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #f6f7f9;
      color: #111;
      font-weight: 700;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .pill.salida {
      background: #FFF2C6;
      color: #5a4200;
    }

    .pill.corazon {
      background: #DCEBFF;
      color: #0b2b5a;
    }

    .pill.fondo {
      background: #E8D7C5;
      color: #3c2415;
    }

    .family-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .family-badge {
      border: 0;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: default;
      border: 1px solid rgba(0, 0, 0, 0.08);
      user-select: none;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .desc-preview {
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fafafa;
      white-space: pre-wrap;
      color: #111;
      word-break: break-word;
    }

    .desc-preview a {
      color: #0d6efd;
      text-decoration: underline;
      word-break: break-word;
    }

    .desc-edit {
      width: 100%;
      min-height: 120px;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.95rem;
      resize: vertical;
      display: none;
    }

    .muted {
      color: #666;
      font-style: italic;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .modal-alert-btn {
      background: #111;
      color: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      border: none;
      cursor: pointer;
      display: none;
      white-space: nowrap;
    }

    .modal-alert-btn:hover {
      opacity: 0.92;
    }

    .modal-action-btn {
      border-radius: 12px;
      padding: 10px 12px;
      border: none;
      cursor: pointer;
      color: #fff;
      white-space: nowrap;
    }

    .modal-edit-desc {
      background: #6c757d;
    }

    .modal-save-desc {
      background: #198754;
      display: none;
    }

    .modal-cancel-desc {
      background: #adb5bd;
      color: #111;
      display: none;
    }

    @media (max-width: 520px) {
      body {
        align-items: flex-start;
      }

      .container {
        width: 100%;
        max-width: 100%;
        border-radius: 0;
        padding: 14px 12px;
      }

      h1 {
        font-size: 1.25rem;
        padding: 0 42px;
        margin-bottom: 14px;
      }

      .next-button {
        top: 8px;
        right: 8px;
      }

      form input,
      form textarea,
      #search,
      .multi-select-trigger {
        font-size: 0.96rem;
        padding: 10px;
      }

      .row-2 {
        grid-template-columns: 1fr;
      }

      #tableSearchBar {
        padding: 10px;
      }

      table {
        font-size: 0.9rem;
        min-width: 640px;
      }

      .json-footer {
        justify-content: stretch;
      }

      .json-footer .tool-btn {
        width: 100%;
      }

      .note-btn {
        padding: 10px 8px;
        font-size: 0.92rem;
      }

      .modal-body {
        padding: 14px;
      }

      .list-header {
        gap: 8px;
      }

      .sort-wrap,
      .sort-wrap .tool-btn {
        width: 100%;
      }

      .sort-menu {
        left: 0;
        right: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Biblioteca Olfativa</h1>

    <a href="perfumes.html" class="next-button" aria-label="Ir a perfumes">→</a>

    <form id="essenceForm">
      <input type="text" id="name" placeholder="Nombre de Ingrediente" required />

      <div class="row-2">
        <div class="suggest-wrap">
          <input type="text" id="place" placeholder="Lugar almacenado" autocomplete="off" required />
          <div id="placeSuggest" class="suggest-list"></div>
        </div>

        <div class="suggest-wrap">
          <input type="text" id="provider" placeholder="Proveedor (opcional)" autocomplete="off" />
          <div id="providerSuggest" class="suggest-list"></div>
        </div>
      </div>

      <div class="multi-select" id="familySelect">
        <button type="button" class="multi-select-trigger" id="familyTrigger" aria-haspopup="listbox"
          aria-expanded="false">
          <div class="multi-select-chips" id="familyChips">
            <span class="multi-select-placeholder">Seleccionar familias olfativas (podés elegir varias)</span>
          </div>
          <span aria-hidden="true">▾</span>
        </button>
        <div class="multi-select-panel" id="familyPanel" role="listbox" aria-multiselectable="true"></div>
      </div>

      <div class="note-toggle" id="noteToggle">
        <div class="note-btn note-salida" data-note="salida" role="button" tabindex="0">Salida</div>
        <div class="note-btn note-corazon" data-note="corazon" role="button" tabindex="0">Corazón</div>
        <div class="note-btn note-fondo" data-note="fondo" role="button" tabindex="0">Fondo</div>
      </div>

      <textarea id="description" placeholder="Descripción (opcional)"></textarea>

      <button type="submit">Agregar</button>
    </form>

    <div id="essenceContainer">
      <!-- ✅ h2 + filtro a la derecha (dropdown) -->
      <div class="list-header">
        <h2>Lista de Ingredientes</h2>

        <div class="sort-wrap">
          <button id="sortButton" class="tool-btn primary" type="button" aria-haspopup="true" aria-expanded="false">
            Orden: Lugar ↑
          </button>
          <div id="sortMenu" class="sort-menu" aria-hidden="true"></div>
        </div>
      </div>

      <div id="tableSearchBar">
        <div class="search-wrap">
          <input type="text" id="search"
            placeholder="Buscar (nombre/lugar/proveedor) o por coma: Floral, Cítrica, Salida" />
          <button id="clearSearch" class="clear-btn" type="button" aria-label="Borrar búsqueda">×</button>
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th id="placeHeader" class="th-clickable" title="Filtrar por lugar">
                Lugar almacenado <span class="th-caret">▾</span>
                <div id="placeHeaderMenu" class="th-menu" aria-hidden="true"></div>
              </th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="essenceGrid"></tbody>
        </table>
      </div>

      <div class="json-footer">
        <button id="exportBtn" class="tool-btn" type="button">Exportar JSON</button>
        <button id="importBtn" class="tool-btn secondary" type="button">Importar JSON</button>
        <input id="importFile" type="file" accept="application/json,.json" style="display:none;" />
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div>
          <h3 class="modal-title" id="modalTitle">Detalle</h3>
          <div class="provider-line" id="modalProvider"></div>
        </div>
        <button class="modal-close" id="modalClose" type="button" aria-label="Cerrar">×</button>
      </div>

      <div class="modal-body">
        <div class="meta-line" id="modalMeta"></div>
        <div class="family-badges" id="modalFamilies"></div>
        <div id="modalDescPreview" class="desc-preview"></div>
        <textarea id="modalDescEdit" class="desc-edit" placeholder="Sin descripción..."></textarea>

        <div class="modal-actions">
          <button id="modalEditDescBtn" type="button" class="modal-action-btn modal-edit-desc">Editar descripción</button>
          <button id="modalSaveDescBtn" type="button" class="modal-action-btn modal-save-desc">Guardar</button>
          <button id="modalCancelDescBtn" type="button" class="modal-action-btn modal-cancel-desc">Cancelar</button>

          <button id="modalAlertBtn" type="button" class="modal-alert-btn">Alertar falta de stock</button>
        </div>

        <div id="modalAlertHint" class="hint" style="display:none;">
          Se enviará una notificación: <b>“Sin stock de: ...”</b>
        </div>
      </div>
    </div>
  </div>

  <script>
    function normalizeText(value) {
      return (value ?? '')
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function escapeHtml(str) {
      return (str ?? '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function escapeHtmlAttr(str) {
      return escapeHtml(str).replace(/`/g, '&#096;');
    }

    function cryptoRandomId() {
      if (window.crypto?.randomUUID) return crypto.randomUUID();
      return `id_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function toPositiveInt(value) {
      const n = Number(value);
      if (!Number.isFinite(n)) return null;
      const i = Math.trunc(n);
      if (i <= 0) return null;
      return i;
    }

    function linkifySafe(text) {
      const escaped = escapeHtml(text ?? '');
      const urlRegex = /\bhttps?:\/\/[^\s<]+/gi;
      return escaped.replace(urlRegex, (url) => {
        const safeUrl = escapeHtmlAttr(url);
        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
      });
    }

    function levenshtein(a, b) {
      const s = (a ?? '').toString();
      const t = (b ?? '').toString();
      const n = s.length;
      const m = t.length;
      if (n === 0) return m;
      if (m === 0) return n;

      const v0 = new Array(m + 1);
      const v1 = new Array(m + 1);

      for (let i = 0; i <= m; i++) v0[i] = i;

      for (let i = 0; i < n; i++) {
        v1[0] = i + 1;
        for (let j = 0; j < m; j++) {
          const cost = s[i] === t[j] ? 0 : 1;
          v1[j + 1] = Math.min(
            v1[j] + 1,
            v0[j + 1] + 1,
            v0[j] + cost
          );
        }
        for (let j = 0; j <= m; j++) v0[j] = v1[j];
      }
      return v1[m];
    }

    function fuzzyPick(token, candidates) {
      const q = normalizeText(token).trim();
      if (!q) return null;

      let best = null;
      let bestScore = Infinity;

      for (const c of candidates) {
        const cc = normalizeText(c);
        const d = levenshtein(q, cc);
        if (d < bestScore) {
          bestScore = d;
          best = c;
        }
      }

      const len = Math.max(1, q.length);
      const allowed = len <= 6 ? 1 : len <= 10 ? 2 : 3;
      if (bestScore <= allowed) return best;

      const partial = candidates.find(c => normalizeText(c).includes(q));
      return partial || null;
    }

    const STORAGE_KEY = 'essences';

    /* ✅ respetando tus familias y colores (incluye Acuática y Dulce) */
    const FAMILIES = [
      'Aromática', 'Amaderada', 'Ambarada', 'Almizclada', 'Floral', 'Cuero', 'Oriental', 'Especiada', 'Balsámica',
      'Resinosa', 'Frutal', 'Cítrica','Gourmand', 'Herbal', 'Verde', 'Aldehídica', 'Animalic', 'Acuática', 'Ozónica', 'Terrosa','Empolvada', 'Ahumada','Dulce', 'Metálica', 'Licorosa', 'Lactónica', 'Anisada', 'Mielada',
    ];

    const FAMILY_META = {
      'Aromática': { bg: '#0F766E', fg: '#FFFFFF' },
      'Amaderada': { bg: '#7C2D12', fg: '#FFFFFF' },
      'Ambarada': { bg: '#D68F00', fg: '#111827' },
      'Almizclada': { bg: '#E3E3E3', fg: '#000000' },
      'Floral': { bg: '#EC4899', fg: '#FFFFFF' },
      'Cuero': { bg: '#3F2A1D', fg: '#FFFFFF' },
      'Oriental': { bg: '#2D0075', fg: '#FFFFFF' },
      'Especiada': { bg: '#DC2626', fg: '#FFFFFF' },
      'Balsámica': { bg: '#065F46', fg: '#FFFFFF' },
      'Resinosa': { bg: '#92400E', fg: '#FFFFFF' },
      'Frutal': { bg: '#FB7185', fg: '#111827' },
      'Gourmand': { bg: '#6B21A8', fg: '#FFFFFF' },
      'Herbal': { bg: '#16A34A', fg: '#FFFFFF' },
      'Verde': { bg: '#96D99A', fg: '#111827' },
      'Aldehídica': { bg: '#0EA5E9', fg: '#FFFFFF' },
      'Animalic': { bg: '#A16207', fg: '#FFFFFF' },
      'Acuática': { bg: '#0369A1', fg: '#FFFFFF' },
      'Ozónica': { bg: '#E0F2FE', fg: '#0F172A' },
      'Terrosa': { bg: '#78350F', fg: '#FFFFFF' },
      'Empolvada': { bg: '#E9D5FF', fg: '#4C1D95' },
      'Ahumada': { bg: '#374151', fg: '#FFFFFF' },
      'Metálica': { bg: '#9CA3AF', fg: '#111827' },
      'Licorosa': { bg: '#BE185D', fg: '#FFFFFF' },
      'Lactónica': { bg: '#FEF3C7', fg: '#7C2D12' },
      'Anisada': { bg: '#2DD4BF', fg: '#0F172A' },
      'Cítrica': { bg: '#F7FF5C', fg: '#111827' },
      'Dulce': { bg: '#E8D373', fg: '#7C2D12' },
      'Mielada': { bg: '#FFD000', fg: '#FFFFFF' },
    };

    function getFamilyStyle(family) {
      const meta = FAMILY_META[family] || { bg: '#EEE', fg: '#111' };
      return `background:${meta.bg};color:${meta.fg};border:1px solid rgba(0,0,0,.08);`;
    }

    function normalizeFamilyToken(token) {
      return normalizeText(token).replace(/\s+/g, ' ').trim();
    }

    function familyFromToken(token) {
      const t = normalizeFamilyToken(token);
      if (!t) return null;
      const exact = FAMILIES.find(f => normalizeFamilyToken(f) === t);
      if (exact) return exact;
      return fuzzyPick(token, FAMILIES);
    }

    const NOTE_ALIASES = {
      'salida': 'salida',
      'corazon': 'corazon',
      'corazón': 'corazon',
      'fondo': 'fondo',
    };

    function noteFromToken(token) {
      const t = normalizeText(token).replace(/\s+/g, ' ').trim();
      return NOTE_ALIASES[t] || null;
    }

    let essences = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    function saveToLocalStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(essences));
    }

    function migrateIfNeeded() {
      let changed = false;
      const byPlace = new Map();
      const oldItems = essences.map(e => ({ ...e }));

      oldItems.forEach((e) => {
        const place = (e.place ?? e.box ?? '').toString().trim();
        const key = place || 'Sin lugar';
        if (!byPlace.has(key)) byPlace.set(key, []);
        byPlace.get(key).push(e);
      });

      const migrated = [];
      for (const [placeKey, items] of byPlace.entries()) {
        items.sort((a, b) => (a.number ?? 0) - (b.number ?? 0));
        let next = 1;

        for (const e of items) {
          const hasLocal = Number.isFinite(e.localId);
          const hasPlace = typeof e.place === 'string' || typeof e.box === 'string';
          if (!hasLocal || !hasPlace) changed = true;

          migrated.push({
            id: e.id ?? cryptoRandomId(),
            place: (e.place ?? e.box ?? placeKey).toString().trim() || placeKey,
            localId: hasLocal ? e.localId : next++,
            name: (e.name ?? '').toString(),
            provider: (e.provider ?? '').toString(),
            stock: e.stock ?? 'available',
            families: Array.isArray(e.families) ? e.families : [],
            notes: Array.isArray(e.notes) ? e.notes : [],
            description: typeof e.description === 'string' ? e.description : '',
          });

          if (!Array.isArray(e.families) || !Array.isArray(e.notes) || typeof e.provider !== 'string') changed = true;
        }
      }

      essences = migrated;
      if (changed) saveToLocalStorage();
    }

    migrateIfNeeded();

    /* ✅ orden predeterminado: por lugar almacenado */
    let ascending = true;
    let filterMode = 'place'; // 'place' | 'localId' | 'stock'
    const editing = new Map();
    const selectedFamilies = new Set();
    const selectedNotes = new Set();
    let activePlaceFilterKey = null;

    const form = document.getElementById('essenceForm');
    const searchInput = document.getElementById('search');
    const clearSearchBtn = document.getElementById('clearSearch');
    const essenceGrid = document.getElementById('essenceGrid');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');

    const placeInput = document.getElementById('place');
    const providerInput = document.getElementById('provider');

    const placeSuggest = document.getElementById('placeSuggest');
    const providerSuggest = document.getElementById('providerSuggest');

    const familySelect = document.getElementById('familySelect');
    const familyTrigger = document.getElementById('familyTrigger');
    const familyPanel = document.getElementById('familyPanel');
    const familyChips = document.getElementById('familyChips');

    const noteToggle = document.getElementById('noteToggle');

    const placeHeader = document.getElementById('placeHeader');
    const placeHeaderMenu = document.getElementById('placeHeaderMenu');

    const sortButton = document.getElementById('sortButton');
    const sortMenu = document.getElementById('sortMenu');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalProvider = document.getElementById('modalProvider');
    const modalMeta = document.getElementById('modalMeta');
    const modalFamilies = document.getElementById('modalFamilies');

    const modalDescPreview = document.getElementById('modalDescPreview');
    const modalDescEdit = document.getElementById('modalDescEdit');
    const modalEditDescBtn = document.getElementById('modalEditDescBtn');
    const modalSaveDescBtn = document.getElementById('modalSaveDescBtn');
    const modalCancelDescBtn = document.getElementById('modalCancelDescBtn');

    const modalAlertBtn = document.getElementById('modalAlertBtn');
    const modalAlertHint = document.getElementById('modalAlertHint');

    let currentModalEssenceId = null;
    let modalDescEditing = false;
    let modalDescDraft = '';

    window.addEventListener('DOMContentLoaded', () => {
      buildFamilyPanel();
      updateFamilyChips();
      wireNotesUI();

      renderPlaceSuggestions();
      renderProviderSuggestions();
      buildPlaceHeaderMenu();
      buildSortMenu();

      updateSortButtonText();
      syncClearButton();
      render();
    });

    function syncClearButton() {
      const has = !!searchInput.value.trim();
      clearSearchBtn.style.display = has ? 'inline-flex' : 'none';
    }

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      syncClearButton();
      searchInput.focus();
      render();
    });

    function uniquePlaces() {
      const m = new Map();
      for (const e of essences) {
        const p = (e.place ?? '').toString().trim();
        if (!p) continue;
        const k = normalizeText(p);
        if (!m.has(k)) m.set(k, p);
      }
      return [...m.values()].sort((a, b) => normalizeText(a).localeCompare(normalizeText(b)));
    }

    function uniqueProviders() {
      const m = new Map();
      for (const e of essences) {
        const p = (e.provider ?? '').toString().trim();
        if (!p) continue;
        const k = normalizeText(p);
        if (!m.has(k)) m.set(k, p);
      }
      return [...m.values()].sort((a, b) => normalizeText(a).localeCompare(normalizeText(b)));
    }

    function placeCounts() {
      const counts = new Map();
      let total = 0;

      for (const e of essences) {
        total += 1;
        const label = (e.place ?? '').toString().trim() || 'Sin lugar';
        const key = normalizeText(label);
        const prev = counts.get(key);
        if (!prev) counts.set(key, { label, count: 1 });
        else prev.count += 1;
      }

      return { total, counts };
    }

    function openPlaceSuggest() { placeSuggest.classList.add('open'); }
    function closePlaceSuggest() { placeSuggest.classList.remove('open'); }

    function renderPlaceSuggestions() {
      const all = uniquePlaces();
      const q = normalizeText(placeInput.value.trim());
      const filtered = q ? all.filter(p => normalizeText(p).includes(q)) : all.slice(0, 8);

      if (filtered.length === 0) {
        placeSuggest.innerHTML = `<div class="suggest-empty">Sin sugerencias</div>`;
        return;
      }

      placeSuggest.innerHTML = filtered
        .slice(0, 12)
        .map(p => `<div class="suggest-item" data-value="${escapeHtmlAttr(p)}">${escapeHtml(p)}</div>`)
        .join('');
    }

    placeInput.addEventListener('focus', () => {
      renderPlaceSuggestions();
      openPlaceSuggest();
    });

    placeInput.addEventListener('input', () => {
      renderPlaceSuggestions();
      openPlaceSuggest();
    });

    placeSuggest.addEventListener('click', (e) => {
      const item = e.target.closest('.suggest-item');
      if (!item) return;
      placeInput.value = item.dataset.value ?? '';
      closePlaceSuggest();
      placeInput.focus();
    });

    function openProviderSuggest() { providerSuggest.classList.add('open'); }
    function closeProviderSuggest() { providerSuggest.classList.remove('open'); }

    function renderProviderSuggestions() {
      const all = uniqueProviders();
      const q = normalizeText(providerInput.value.trim());
      const filtered = q ? all.filter(p => normalizeText(p).includes(q)) : all.slice(0, 8);

      if (filtered.length === 0) {
        providerSuggest.innerHTML = `<div class="suggest-empty">Sin sugerencias</div>`;
        return;
      }

      providerSuggest.innerHTML = filtered
        .slice(0, 12)
        .map(p => `<div class="suggest-item" data-value="${escapeHtmlAttr(p)}">${escapeHtml(p)}</div>`)
        .join('');
    }

    providerInput.addEventListener('focus', () => {
      renderProviderSuggestions();
      openProviderSuggest();
    });

    providerInput.addEventListener('input', () => {
      renderProviderSuggestions();
      openProviderSuggest();
    });

    providerSuggest.addEventListener('click', (e) => {
      const item = e.target.closest('.suggest-item');
      if (!item) return;
      providerInput.value = item.dataset.value ?? '';
      closeProviderSuggest();
      providerInput.focus();
    });

    function wireNotesUI() {
      noteToggle.addEventListener('click', (e) => {
        const btn = e.target.closest('.note-btn');
        if (!btn) return;
        toggleNote(btn.dataset.note);
      });

      noteToggle.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        const btn = e.target.closest('.note-btn');
        if (!btn) return;
        e.preventDefault();
        toggleNote(btn.dataset.note);
      });
    }

    function toggleNote(note) {
      if (!note) return;
      if (selectedNotes.has(note)) selectedNotes.delete(note);
      else selectedNotes.add(note);
      syncNotesButtons();
    }

    function syncNotesButtons() {
      for (const el of noteToggle.querySelectorAll('.note-btn')) {
        const note = el.dataset.note;
        el.classList.toggle('active', selectedNotes.has(note));
      }
    }

    function openPlaceHeaderMenu() {
      placeHeaderMenu.classList.add('open');
      placeHeaderMenu.setAttribute('aria-hidden', 'false');
    }

    function closePlaceHeaderMenu() {
      placeHeaderMenu.classList.remove('open');
      placeHeaderMenu.setAttribute('aria-hidden', 'true');
    }

    function togglePlaceHeaderMenu() {
      if (placeHeaderMenu.classList.contains('open')) closePlaceHeaderMenu();
      else {
        buildPlaceHeaderMenu();
        openPlaceHeaderMenu();
      }
    }

    /* ✅ ahora el texto incluye (count): "Caja 1 (32)" */
    function buildPlaceHeaderMenu() {
      const { total, counts } = placeCounts();
      const places = uniquePlaces();

      const items = [
        { label: 'Todos', key: null, count: total },
        ...places.map(p => {
          const k = normalizeText(p);
          return { label: p, key: k, count: counts.get(k)?.count ?? 0 };
        }),
      ];

      placeHeaderMenu.innerHTML = items
        .map(it => {
          const label = `${it.label} (${it.count})`;
          return `<div class="th-menu-item" data-key="${it.key === null ? '' : escapeHtmlAttr(it.key)}">${escapeHtml(label)}</div>`;
        })
        .join('');
    }

    placeHeader.addEventListener('click', (e) => {
      const menuItem = e.target.closest('.th-menu-item');
      if (menuItem) return;
      togglePlaceHeaderMenu();
    });

    placeHeaderMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.th-menu-item');
      if (!item) return;
      const key = item.dataset.key ?? '';
      activePlaceFilterKey = key ? key : null;
      closePlaceHeaderMenu();
      render();
    });

    /* ✅ Sort dropdown */
    function buildSortMenu() {
      sortMenu.innerHTML = `
        <div class="sort-item" data-mode="place" data-dir="asc">Lugar ↑</div>
        <div class="sort-item" data-mode="place" data-dir="desc">Lugar ↓</div>
        <div class="sort-item" data-mode="localId" data-dir="asc">ID ↑</div>
        <div class="sort-item" data-mode="localId" data-dir="desc">ID ↓</div>
        <div class="sort-item" data-mode="stock" data-dir="asc">Stock ↑</div>
        <div class="sort-item" data-mode="stock" data-dir="desc">Stock ↓</div>
      `;
    }

    function openSortMenu() {
      sortMenu.classList.add('open');
      sortMenu.setAttribute('aria-hidden', 'false');
      sortButton.setAttribute('aria-expanded', 'true');
    }

    function closeSortMenu() {
      sortMenu.classList.remove('open');
      sortMenu.setAttribute('aria-hidden', 'true');
      sortButton.setAttribute('aria-expanded', 'false');
    }

    sortButton.addEventListener('click', () => {
      if (sortMenu.classList.contains('open')) closeSortMenu();
      else openSortMenu();
    });

    sortMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.sort-item');
      if (!item) return;
      filterMode = item.dataset.mode;
      ascending = item.dataset.dir === 'asc';
      updateSortButtonText();
      closeSortMenu();
      render();
    });

    function updateSortButtonText() {
      const arrow = ascending ? '↑' : '↓';
      const modeText = filterMode === 'place' ? 'Lugar' : (filterMode === 'stock' ? 'Stock' : 'ID');
      sortButton.textContent = `Orden: ${modeText} ${arrow}`;
    }

    document.addEventListener('click', (e) => {
      if (!familySelect.contains(e.target)) closeFamilyPanel();

      const wrapPlace = placeInput.closest('.suggest-wrap');
      if (wrapPlace && !wrapPlace.contains(e.target)) closePlaceSuggest();

      const wrapProvider = providerInput.closest('.suggest-wrap');
      if (wrapProvider && !wrapProvider.contains(e.target)) closeProviderSuggest();

      if (!placeHeader.contains(e.target)) closePlaceHeaderMenu();
      if (!sortButton.contains(e.target) && !sortMenu.contains(e.target)) closeSortMenu();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeFamilyPanel();
        closeModal();
        closePlaceSuggest();
        closeProviderSuggest();
        closePlaceHeaderMenu();
        closeSortMenu();
      }
    });

    exportBtn.addEventListener('click', () => {
      const payload = { version: 6, exportedAt: new Date().toISOString(), essences };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblioteca_olfativa_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importFile.click());

    importFile.addEventListener('change', async () => {
      const file = importFile.files?.[0];
      importFile.value = '';
      if (!file) return;

      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        const incomingRaw = Array.isArray(parsed) ? parsed : (parsed?.essences ?? null);

        if (!Array.isArray(incomingRaw)) {
          alert('JSON inválido: se esperaba un array o { essences: [...] }.');
          return;
        }

        const choice = prompt(
          'Importar JSON:\n\n' +
          '1 = Reemplazar (borra lo actual)\n' +
          '2 = Combinar (merge por id)\n\n' +
          'Escribí 1 o 2:'
        );

        if (!choice) return;

        const incoming = sanitizeImportedEssences(incomingRaw);

        if (choice.trim() === '1') {
          const ok = confirm('Vas a REEMPLAZAR tus datos actuales. ¿Continuar?');
          if (!ok) return;
          essences = incoming;
        } else if (choice.trim() === '2') {
          essences = mergeEssencesById(essences, incoming);
        } else {
          alert('Opción inválida. Usá 1 o 2.');
          return;
        }

        essences = ensureLocalIdsPerPlace(essences);

        saveToLocalStorage();
        closeModal();

        renderPlaceSuggestions();
        renderProviderSuggestions();
        buildPlaceHeaderMenu();
        render();
      } catch {
        alert('No se pudo importar el JSON. Verificá que sea un archivo válido.');
      }
    });

    function sanitizeImportedEssences(items) {
      const cleaned = [];
      for (const raw of items) {
        const name = (raw?.name ?? '').toString().trim();
        const place = (raw?.place ?? raw?.box ?? '').toString().trim();
        if (!name || !place) continue;

        const id = (raw?.id ?? '').toString().trim() || cryptoRandomId();
        const localId = toPositiveInt(raw?.localId) ?? null;
        const stock = ['available', 'low', 'out'].includes(raw?.stock) ? raw.stock : 'available';

        const families = Array.isArray(raw?.families)
          ? raw.families.map(x => (x ?? '').toString().trim()).filter(Boolean).filter(f => FAMILIES.includes(f))
          : [];

        const notes = Array.isArray(raw?.notes)
          ? raw.notes.map(x => (x ?? '').toString().trim().toLowerCase()).filter(Boolean)
          : [];

        const description = (raw?.description ?? '').toString();
        const provider = (raw?.provider ?? '').toString();

        cleaned.push({ id, localId, name, place, provider, stock, families, notes, description });
      }
      return cleaned;
    }

    function mergeEssencesById(existing, incoming) {
      const map = new Map(existing.map(e => [e.id, { ...e }]));
      for (const e of incoming) map.set(e.id, { ...e });
      return [...map.values()];
    }

    function ensureLocalIdsPerPlace(items) {
      const result = items.map(e => ({ ...e }));
      const byPlace = new Map();

      for (const e of result) {
        const key = normalizeText(e.place);
        if (!byPlace.has(key)) byPlace.set(key, []);
        byPlace.get(key).push(e);
      }

      for (const [, list] of byPlace.entries()) {
        const used = new Set();
        let max = 0;

        for (const e of list) {
          const v = toPositiveInt(e.localId);
          if (v && !used.has(v)) {
            e.localId = v;
            used.add(v);
            if (v > max) max = v;
          } else {
            e.localId = null;
          }
        }

        for (const e of list) {
          if (!e.localId) {
            max += 1;
            while (used.has(max)) max += 1;
            e.localId = max;
            used.add(max);
          }
        }
      }

      return result;
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const place = placeInput.value.trim();
      const provider = providerInput.value.trim();
      const description = document.getElementById('description').value.trim();

      if (!name || !place) return;

      const localId = nextLocalIdForPlace(place);

      essences.push({
        id: cryptoRandomId(),
        localId,
        name,
        place,
        provider: provider || '',
        stock: 'available',
        families: [...selectedFamilies],
        notes: [...selectedNotes],
        description: description || '',
      });

      saveToLocalStorage();
      form.reset();

      selectedFamilies.clear();
      selectedNotes.clear();
      syncNotesButtons();
      updateFamilyChips();

      renderPlaceSuggestions();
      renderProviderSuggestions();
      buildPlaceHeaderMenu();
      render();
    });

    searchInput.addEventListener('input', () => {
      syncClearButton();
      render();
    });
    
    // ✅ Abrir/cerrar panel de familias
familyTrigger.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  toggleFamilyPanel();
});

// ✅ Evita que al clickear dentro del panel se cierre por el listener global
familyPanel.addEventListener('click', (e) => {
  e.stopPropagation();
});

    const familyPanelEl = document.getElementById('familyPanel');

    function nextLocalIdForPlace(place) {
      const p = normalizeText(place);
      const same = essences.filter(e => normalizeText(e.place) === p);
      const maxId = same.length ? Math.max(...same.map(e => Number(e.localId) || 0)) : 0;
      return maxId + 1;
    }

    function isLocalIdUsed(place, localId, excludeEssenceId = null) {
      const p = normalizeText(place);
      return essences.some(e =>
        e.id !== excludeEssenceId &&
        normalizeText(e.place) === p &&
        Number(e.localId) === Number(localId)
      );
    }

    function parseSearchQuery(raw) {
      const parts = (raw ?? '').split(',').map(s => s.trim()).filter(Boolean);
      if (parts.length === 0) return { familyFilters: [], noteFilters: [], text: '' };

      const familyFilters = [];
      const noteFilters = [];
      const textParts = [];

      for (const part of parts) {
        const fam = familyFromToken(part);
        if (fam) {
          familyFilters.push(fam);
          continue;
        }

        const note = noteFromToken(part);
        if (note) {
          noteFilters.push(note);
          continue;
        }

        textParts.push(part);
      }

      return { familyFilters, noteFilters, text: textParts.join(' ') };
    }

    function sortList(list) {
      if (filterMode === 'stock') {
        const order = ['available', 'low', 'out'];
        return [...list].sort((a, b) => {
          const diff = order.indexOf(a.stock) - order.indexOf(b.stock);
          return ascending ? diff : -diff;
        });
      }

      if (filterMode === 'place') {
        return [...list].sort((a, b) => {
          const ap = normalizeText(a.place);
          const bp = normalizeText(b.place);
          const pDiff = ap.localeCompare(bp);
          if (pDiff !== 0) return ascending ? pDiff : -pDiff;

          const idDiff = (Number(a.localId) || 0) - (Number(b.localId) || 0);
          return ascending ? idDiff : -idDiff;
        });
      }

      return [...list].sort((a, b) => {
        const diff = (Number(a.localId) || 0) - (Number(b.localId) || 0);
        return ascending ? diff : -diff;
      });
    }

    function render() {
      const { familyFilters, noteFilters, text } = parseSearchQuery(searchInput.value.trim());
      const textQuery = normalizeText(text);

      let list = essences;

      if (activePlaceFilterKey) {
        list = list.filter(e => normalizeText(e.place) === activePlaceFilterKey);
      }

      if (familyFilters.length > 0) {
        const wanted = familyFilters.map(f => normalizeText(f));
        list = list.filter(e => Array.isArray(e.families) && e.families.some(f => wanted.includes(normalizeText(f))));
      }

      if (noteFilters.length > 0) {
        const wantedNotes = noteFilters.map(n => normalizeText(n));
        list = list.filter(e => Array.isArray(e.notes) && e.notes.some(n => wantedNotes.includes(normalizeText(n))));
      }

      let familyFromText = null;
      if (textQuery && !textQuery.includes(' ')) {
        familyFromText = fuzzyPick(textQuery, FAMILIES);
      }

      if (familyFromText) {
        const wanted = normalizeText(familyFromText);
        list = list.filter(e => Array.isArray(e.families) && e.families.some(f => normalizeText(f) === wanted));
      } else if (textQuery) {
        list = list.filter((e) =>
          normalizeText(e.name).includes(textQuery) ||
          normalizeText(e.place).includes(textQuery) ||
          normalizeText(e.provider).includes(textQuery)
        );
      }

      const itemsSorted = sortList(list);
      essenceGrid.innerHTML = '';
      for (const essence of itemsSorted) appendIngredientRow(essence);
    }

    function appendIngredientRow(essence) {
      const isEditing = editing.has(essence.id);
      const row = document.createElement('tr');
      row.dataset.id = essence.id;

      row.innerHTML = `
        <td>
          ${isEditing
          ? `<input class="edit-input" type="number" min="1" step="1" inputmode="numeric" data-field="localId" value="${escapeHtmlAttr(String(essence.localId ?? ''))}" />`
          : `${Number(essence.localId) || ''}`
        }
        </td>

        <td>
          ${isEditing
          ? `<input class="edit-input" type="text" data-field="name" value="${escapeHtmlAttr(essence.name)}" />`
          : `<span class="name-link" role="button" tabindex="0" data-action="open-details" data-id="${escapeHtmlAttr(essence.id)}">${escapeHtml(essence.name)}</span>`
        }
        </td>

        <td title="${escapeHtmlAttr(essence.place)}">
          ${isEditing
          ? `<input class="edit-input" type="text" data-field="place" value="${escapeHtmlAttr(essence.place)}" />`
          : `${escapeHtml(essence.place)}`
        }
        </td>

        <td>
          <button
            class="stock-button ${getStockClass(essence.stock)}"
            data-action="toggle-stock"
            data-id="${escapeHtmlAttr(essence.id)}"
            type="button"
            ${isEditing ? 'disabled aria-disabled="true"' : ''}
          >
            ${getStockText(essence.stock)}
          </button>
        </td>

        <td>
          <div class="row-actions">
            ${isEditing
          ? `
                <button class="btn btn-save" data-action="save" data-id="${escapeHtmlAttr(essence.id)}" type="button">Guardar</button>
                <button class="btn btn-cancel" data-action="cancel" data-id="${escapeHtmlAttr(essence.id)}" type="button">Cancelar</button>
              `
          : `
                <button class="btn btn-edit" data-action="edit" data-id="${escapeHtmlAttr(essence.id)}" type="button">Editar</button>
                <button class="btn btn-delete" data-action="delete" data-id="${escapeHtmlAttr(essence.id)}" type="button">Eliminar</button>
              `
        }
          </div>
        </td>
      `;

      essenceGrid.appendChild(row);
    }

    function getStockClass(stock) {
      if (stock === 'available') return 'stock-available';
      if (stock === 'low') return 'stock-low';
      if (stock === 'out') return 'stock-out';
      return '';
    }

    function getStockText(stock) {
      if (stock === 'available') return 'Disponible';
      if (stock === 'low') return 'Bajo';
      if (stock === 'out') return 'Agotado';
      return '';
    }

    function buildFamilyPanel() {
      familyPanel.innerHTML = '';
      for (const fam of FAMILIES) {
        const id = `fam_${normalizeFamilyToken(fam).replace(/\s+/g, '_')}`;

        const row = document.createElement('label');
        row.className = 'family-option';
        row.setAttribute('for', id);

        const swatch = document.createElement('span');
        swatch.className = 'family-swatch';
        swatch.style.cssText = getFamilyStyle(fam);

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.value = fam;
        cb.checked = selectedFamilies.has(fam);

        cb.addEventListener('change', () => {
          if (cb.checked) selectedFamilies.add(fam);
          else selectedFamilies.delete(fam);
          updateFamilyChips();
        });

        const txt = document.createElement('span');
        txt.textContent = fam;

        row.appendChild(swatch);
        row.appendChild(cb);
        row.appendChild(txt);
        familyPanel.appendChild(row);
      }
    }

    function updateFamilyChips() {
      familyChips.innerHTML = '';
      const selected = [...selectedFamilies];

      if (selected.length === 0) {
        const empty = document.createElement('span');
        empty.className = 'multi-select-placeholder';
        empty.textContent = 'Seleccionar familias olfativas (podés elegir varias)';
        familyChips.appendChild(empty);
        return;
      }

      for (const fam of selected) {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.style.cssText = getFamilyStyle(fam);
        chip.innerHTML = `${escapeHtml(fam)} <span class="x" title="Quitar" aria-label="Quitar">×</span>`;

        chip.querySelector('.x')?.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedFamilies.delete(fam);
          const cb = familyPanel.querySelector(`input[type="checkbox"][value="${CSS.escape(fam)}"]`);
          if (cb) cb.checked = false;
          updateFamilyChips();
        });

        familyChips.appendChild(chip);
      }
    }

    function toggleFamilyPanel() {
      const open = familyPanel.classList.toggle('open');
      familyTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    function closeFamilyPanel() {
      familyPanel.classList.remove('open');
      familyTrigger.setAttribute('aria-expanded', 'false');
    }

    essenceGrid.addEventListener('click', (e) => {
      const nameEl = e.target.closest('[data-action="open-details"]');
      if (nameEl) {
        const id = nameEl.dataset.id;
        if (id) openDetails(id);
        return;
      }

      const btn = e.target.closest('button');
      if (!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!action || !id) return;

      if (action === 'toggle-stock') {
        if (!editing.has(id)) toggleStock(id);
        return;
      }

      if (action === 'delete') {
        if (!editing.has(id)) deleteEssence(id);
        return;
      }

      if (action === 'edit') return startEdit(id);
      if (action === 'cancel') return cancelEdit(id);
      if (action === 'save') return saveEdit(id);
    });

    essenceGrid.addEventListener('focusin', (e) => {
      const input = e.target.closest('input[data-field="localId"]');
      if (!input) return;
      input.select();
    });

    essenceGrid.addEventListener('mouseup', (e) => {
      const input = e.target.closest('input[data-field="localId"]');
      if (!input) return;
      e.preventDefault();
      input.select();
    });

    function findIndexById(id) {
      return essences.findIndex(e => e.id === id);
    }

    function startEdit(id) {
      const idx = findIndexById(id);
      if (idx === -1) return;
      const e = essences[idx];
      editing.set(id, { localId: e.localId, name: e.name, place: e.place });
      render();

      const row = essenceGrid.querySelector(`tr[data-id="${CSS.escape(String(id))}"]`);
      const idInput = row?.querySelector('input[data-field="localId"]');
      idInput?.focus();
      idInput?.select();
    }

    function cancelEdit(id) {
      const original = editing.get(id);
      if (!original) return;

      const idx = findIndexById(id);
      if (idx !== -1) {
        essences[idx].localId = original.localId;
        essences[idx].name = original.name;
        essences[idx].place = original.place;
      }

      editing.delete(id);
      saveToLocalStorage();
      render();
      renderPlaceSuggestions();
      renderProviderSuggestions();
      buildPlaceHeaderMenu();
    }

    function saveEdit(id) {
      const idx = findIndexById(id);
      if (idx === -1) return;

      const row = essenceGrid.querySelector(`tr[data-id="${CSS.escape(String(id))}"]`);
      if (!row) return;

      const localIdInput = row.querySelector('input[data-field="localId"]');
      const nameInput = row.querySelector('input[data-field="name"]');
      const placeInputRow = row.querySelector('input[data-field="place"]');

      const newLocalId = toPositiveInt(localIdInput?.value);
      const newName = (nameInput?.value ?? '').trim();
      const newPlace = (placeInputRow?.value ?? '').trim();

      if (!newName || !newPlace) {
        alert('Nombre y lugar son obligatorios.');
        return;
      }

      const prev = essences[idx];
      const finalLocalId = newLocalId ?? nextLocalIdForPlace(newPlace);

      if (!finalLocalId) {
        alert('ID inválida.');
        return;
      }

      if (isLocalIdUsed(newPlace, finalLocalId, id)) {
        alert(`La ID ${finalLocalId} ya existe en "${newPlace}". Elegí otra.`);
        return;
      }

      prev.name = newName;
      prev.place = newPlace;
      prev.localId = finalLocalId;

      editing.delete(id);
      saveToLocalStorage();

      if (activePlaceFilterKey && activePlaceFilterKey !== normalizeText(newPlace)) {
        activePlaceFilterKey = normalizeText(newPlace);
      }

      render();
      renderPlaceSuggestions();
      renderProviderSuggestions();
      buildPlaceHeaderMenu();

      if (currentModalEssenceId === id) openDetails(id);
    }

    function toggleStock(id) {
      const idx = findIndexById(id);
      if (idx === -1) return;

      const states = ['available', 'low', 'out'];
      const current = essences[idx].stock;
      const nextState = states[(states.indexOf(current) + 1) % states.length];
      essences[idx].stock = nextState;

      saveToLocalStorage();
      render();
      if (currentModalEssenceId === id) openDetails(id);
    }

    function deleteEssence(id) {
      const idx = findIndexById(id);
      if (idx === -1) return;

      const ok = confirm('¿Eliminar este ingrediente?');
      if (!ok) return;

      essences.splice(idx, 1);
      saveToLocalStorage();
      closeModal();

      render();
      renderPlaceSuggestions();
      renderProviderSuggestions();
      buildPlaceHeaderMenu();
    }

    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });

    modalEditDescBtn.addEventListener('click', () => {
      if (!currentModalEssenceId) return;
      enterDescEditMode();
    });

    modalCancelDescBtn.addEventListener('click', () => {
      exitDescEditMode(false);
      openDetails(currentModalEssenceId);
    });

    modalSaveDescBtn.addEventListener('click', () => {
      if (!currentModalEssenceId) return;
      const idx = findIndexById(currentModalEssenceId);
      if (idx === -1) return;

      essences[idx].description = modalDescEdit.value ?? '';
      saveToLocalStorage();
      render();
      exitDescEditMode(true);
      openDetails(currentModalEssenceId);
    });

    modalAlertBtn.addEventListener('click', async () => {
      if (!currentModalEssenceId) return;
      const idx = findIndexById(currentModalEssenceId);
      if (idx === -1) return;

      const e = essences[idx];
      const msg = e.stock === 'low'
        ? `Poco stock de: ${e.name || 'Ingrediente'}`
        : `Sin stock de: ${e.name || 'Ingrediente'}`;

      await notifyStockMessage(msg);
    });

    function openDetails(id) {
      const idx = findIndexById(id);
      if (idx === -1) return;

      currentModalEssenceId = id;
      const e = essences[idx];

      modalTitle.textContent = e.name || 'Detalle';
      modalProvider.textContent = e.provider?.trim() ? `Proveedor: ${e.provider}` : '';

      modalMeta.innerHTML = '';
      modalMeta.appendChild(createPill(`Lugar: ${e.place || '—'}`));
      modalMeta.appendChild(createPill(`ID: ${e.localId ?? '—'}`));

      const notes = Array.isArray(e.notes) ? e.notes : [];
      for (const n of notes) {
        if (n === 'salida') modalMeta.appendChild(createPill('Salida', 'salida'));
        if (n === 'corazon') modalMeta.appendChild(createPill('Corazón', 'corazon'));
        if (n === 'fondo') modalMeta.appendChild(createPill('Fondo', 'fondo'));
      }

      modalFamilies.innerHTML = '';
      const fams = Array.isArray(e.families) ? e.families : [];

      if (fams.length === 0) {
        const none = document.createElement('div');
        none.className = 'muted';
        none.textContent = 'Sin familias asignadas.';
        modalFamilies.appendChild(none);
      } else {
        for (const fam of fams) {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'family-badge';
          b.style.cssText = getFamilyStyle(fam);
          b.textContent = fam;
          b.disabled = true;
          modalFamilies.appendChild(b);
        }
      }

      modalDescEditing = false;
      modalDescDraft = (e.description ?? '').toString();
      applyDescMode();

      const isLowOrOut = e.stock === 'low' || e.stock === 'out';
      modalAlertBtn.style.display = isLowOrOut ? 'inline-block' : 'none';
      modalAlertHint.style.display = isLowOrOut ? 'block' : 'none';

      if (e.stock === 'low') {
        modalAlertBtn.textContent = 'Alertar poco stock';
        modalAlertHint.innerHTML = `Se enviará una notificación: <b>“Poco stock de: ...”</b>`;
      } else if (e.stock === 'out') {
        modalAlertBtn.textContent = 'Alertar falta de stock';
        modalAlertHint.innerHTML = `Se enviará una notificación: <b>“Sin stock de: ...”</b>`;
      }

      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden', 'false');
      modalClose.focus();
    }

    function createPill(text, kind) {
      const s = document.createElement('span');
      s.className = `pill${kind ? ' ' + kind : ''}`;
      s.textContent = text;
      return s;
    }

    function enterDescEditMode() {
      if (!currentModalEssenceId) return;
      const idx = findIndexById(currentModalEssenceId);
      if (idx === -1) return;

      modalDescEditing = true;
      modalDescDraft = (essences[idx].description ?? '').toString();
      applyDescMode();

      modalDescEdit.focus();
      modalDescEdit.setSelectionRange(modalDescEdit.value.length, modalDescEdit.value.length);
    }

    function exitDescEditMode(saved) {
      if (!saved && currentModalEssenceId) {
        const idx = findIndexById(currentModalEssenceId);
        if (idx !== -1) modalDescDraft = (essences[idx].description ?? '').toString();
      }
      modalDescEditing = false;
      applyDescMode();
    }

    function applyDescMode() {
      const text = modalDescDraft ?? '';
      if (!modalDescEditing) {
        modalDescEdit.style.display = 'none';
        modalSaveDescBtn.style.display = 'none';
        modalCancelDescBtn.style.display = 'none';
        modalEditDescBtn.style.display = 'inline-block';

        modalDescPreview.innerHTML = text.trim()
          ? linkifySafe(text)
          : `<span class="muted">Sin descripción.</span>`;
      } else {
        modalEditDescBtn.style.display = 'none';
        modalSaveDescBtn.style.display = 'inline-block';
        modalCancelDescBtn.style.display = 'inline-block';

        modalDescEdit.style.display = 'block';
        modalDescEdit.value = text;
        modalDescPreview.innerHTML = '';
      }
    }

    function closeModal() {
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden', 'true');
      currentModalEssenceId = null;
      modalDescEditing = false;
      modalDescDraft = '';
      modalDescEdit.style.display = 'none';
      modalDescPreview.innerHTML = '';
    }

    async function notifyStockMessage(message) {
      if (!('Notification' in window)) {
        alert(message);
        return;
      }

      const isSecure = window.isSecureContext || location.hostname === 'localhost';
      if (!isSecure) {
        alert(message);
        return;
      }

      if (Notification.permission === 'granted') {
        new Notification('Alerta de stock', { body: message });
        return;
      }

      if (Notification.permission === 'denied') {
        alert(message);
        return;
      }

      const permission = await Notification.requestPermission();
      if (permission === 'granted') new Notification('Alerta de stock', { body: message });
      else alert(message);
    }
  </script>
</body>

</html>
