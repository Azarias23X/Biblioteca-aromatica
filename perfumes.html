<!-- =========================================================
FILE: perfumes.html
(Registro de Perfumes + perfil olfativo (2-3 familias) en el modal)
========================================================= -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfumes - Biblioteca Olfativa</title>

    <style>
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width: 100%; max-width: 100%; overflow-x: hidden; }

      body{
        font-family: Arial, sans-serif;
        margin:0; padding:0;
        background:#f9f9f9;
        display:flex; justify-content:center; align-items:center;
        min-height:100vh;
      }

      .container{
        width:92%;
        max-width:920px;
        background:#fff;
        border-radius:10px;
        box-shadow:0 4px 10px rgba(0,0,0,.1);
        padding:20px;
        position:relative;
        overflow:hidden;
      }

      h1{
        text-align:center;
        color:#333;
        margin:0 0 18px;
        padding:0 36px;
        line-height:1.2;
      }

      .back-button{
        position:absolute;
        top:12px; left:12px;
        background:transparent;
        color:#007bff;
        border:none;
        cursor:pointer;
        font-size:1.35rem;
        padding:6px 10px;
        border-radius:10px;
      }
      .back-button:hover{ color:#0056b3; background:#f3f4f6; }

      .card{
        background:#fff;
        border:1px solid #eee;
        border-radius:14px;
        padding:14px;
        margin-bottom:14px;
        box-shadow:0 6px 16px rgba(0,0,0,.06);
      }

      .row{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      input{
        padding:10px;
        border:1px solid #ccc;
        border-radius:12px;
        font-size:1rem;
        width:100%;
      }

      .tool-btn{
        padding:10px 12px;
        border:none;
        border-radius:12px;
        cursor:pointer;
        font-size:1rem;
        color:#fff;
        background:#111;
        white-space:nowrap;
      }
      .tool-btn.primary{ background:#007BFF; }
      .tool-btn.danger{ background:#dc3545; }
      .tool-btn:hover{ opacity:.92; }

      .label{
        font-size:.95rem;
        color:#333;
        font-weight:700;
        margin-bottom:8px;
        text-align:left;
      }

      /* ✅ texto ingrediente según stock */
      .stock-text-available{ color:#111; }
      .stock-text-low{ color:#D68F00; }
      .stock-text-out{ color:#DC2626; }

      /* sugerencias */
      .suggest-wrap{ position:relative; width:100%; }
      .suggest-list{
        position:absolute;
        left:0; right:0;
        top:calc(100% + 6px);
        background:#fff;
        border:1px solid #ddd;
        border-radius:12px;
        box-shadow:0 10px 30px rgba(0,0,0,.12);
        z-index:1200;
        max-height:260px;
        overflow:auto;
        display:none;
      }
      .suggest-list.open{ display:block; }
      .suggest-item{
        padding:10px 12px;
        cursor:pointer;
        border-bottom:1px solid #f1f1f1;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .suggest-item:last-child{ border-bottom:none; }
      .suggest-item:hover{ background:#f6f7f9; }
      .suggest-empty{ padding:10px 12px; color:#666; font-style:italic; }

      /* chips seleccionados */
      .chip-row{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:10px;
      }
      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(0,0,0,.08);
        background:#f6f7f9;
        font-weight:700;
        font-size:.9rem;
        max-width:100%;
      }
      .chip .muted{
        font-weight:600;
        color:#555;
        font-size:.85rem;
        max-width:50vw;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }
      .chip .x{
        cursor:pointer;
        font-weight:900;
        opacity:.75;
      }
      .chip .x:hover{ opacity:1; }

      .list-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin:10px 0;
        flex-wrap:wrap;
      }
      .list-header h2{ margin:0; font-size:1.08rem; }

      .table-scroll{
        width:100%;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        border-radius:12px;
      }

      table{
        width:100%;
        border-collapse:collapse;
        background:#fff;
        font-size:0.92rem;
        min-width:520px;
      }
      thead{ background:#f5f5f5; }
      th, td{
        text-align:left;
        padding:8px 10px;
        border:1px solid #ddd;
        white-space:nowrap;
        vertical-align:middle;
      }
      tr:hover{ background:#f9f9f9; }

      .name-link{
        color:#0d6efd;
        cursor:pointer;
        text-decoration:underline;
      }
      .name-link:hover{ color:#0a58ca; }

      /* Modal */
      .modal-overlay{
        position:fixed;
        inset:0;
        background:rgba(0,0,0,.55);
        display:none;
        align-items:center;
        justify-content:center;
        padding:16px;
        z-index:1500;
      }
      .modal-overlay.open{ display:flex; }

      .modal{
        width:min(720px, 96vw);
        max-height:90vh;
        background:#fff;
        border-radius:14px;
        box-shadow:0 15px 45px rgba(0,0,0,.25);
        overflow:hidden;
        display:flex;
        flex-direction:column;
      }
      .modal-header{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        padding:14px 16px;
        border-bottom:1px solid #eee;
        gap:10px;
      }
      .modal-title{
        margin:0;
        font-size:1.15rem;
        color:#111;
        word-break:break-word;
      }
      .modal-close{
        border:none;
        background:transparent;
        font-size:1.6rem;
        cursor:pointer;
        line-height:1;
        padding:6px 10px;
        border-radius:10px;
        flex:0 0 auto;
      }
      .modal-close:hover{ background:#f3f4f6; }

      .modal-body{
        padding:16px;
        overflow:auto;
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      .hint{
        color:#666;
        font-style:italic;
        font-size:.92rem;
      }

      .pill{
        display:inline-flex;
        align-items:center;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(0,0,0,.08);
        background:#f6f7f9;
        color:#111;
        font-weight:800;
        font-size:0.85rem;
        white-space:nowrap;
      }

      /* ✅ perfil olfativo debajo del nombre */
      .profile-row{
        margin-top:8px;
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        align-items:center;
      }
      .profile-badge{
        border:0;
        padding:7px 10px;
        border-radius:999px;
        font-weight:800;
        font-size:0.85rem;
        border:1px solid rgba(0,0,0,.08);
        cursor:default;
        user-select:none;
        max-width:100%;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      /* ✅ Modal ingredients table: menos separación + lugar más angosto */
      .ingredients-table{
        width:100%;
        border-collapse:collapse;
        background:#fff;
        font-size:.92rem;
        table-layout:fixed;
      }
      .ingredients-table th, .ingredients-table td{
        padding:8px 8px;
        border:1px solid #eee;
        vertical-align:middle;
      }
      .ingredients-table th{ background:#fafafa; }

      .ingredients-table th:nth-child(1),
      .ingredients-table td:nth-child(1){
        width:68%;
        white-space:normal;
        word-break:break-word;
      }
      .ingredients-table th:nth-child(2),
      .ingredients-table td:nth-child(2){
        width:32%;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      @media (max-width:520px){
        body{ align-items:flex-start; }
        .container{
          width:100%;
          max-width:100%;
          border-radius:0;
          padding:14px 12px;
        }
        h1{ font-size:1.25rem; padding:0 42px; margin-bottom:14px; }
        .back-button{ top:8px; left:8px; }
        table{ min-width:560px; }
        .tool-btn{ width:100%; }
        .row{ gap:8px; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Perfumes</h1>

      <button class="back-button" onclick="window.location.href='index.html';" aria-label="Volver">←</button>

      <div class="card">
        <div class="label">Nombre del perfume</div>
        <input id="perfumeName" type="text" placeholder="Ej: Aqua Citrus 01" />

        <div style="height:12px;"></div>

        <div class="label">Agregar ingredientes (desde tu biblioteca)</div>
        <div class="suggest-wrap">
          <input id="ingredientSearch" type="text" placeholder="Escribí para buscar ingrediente..." autocomplete="off" />
          <div id="ingredientSuggest" class="suggest-list"></div>
        </div>

        <div id="selectedChips" class="chip-row"></div>

        <div style="height:12px;"></div>
        <button id="savePerfumeBtn" class="tool-btn primary" type="button">Guardar perfume</button>
        <div class="hint" style="margin-top:10px;">
          Tip: al tocar un perfume en la tabla, vas a ver los ingredientes y su lugar almacenado.
        </div>
      </div>

      <div class="list-header">
        <h2>Lista de Perfumes</h2>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Cantidad ingredientes</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="perfumesGrid"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal detalle perfume -->
    <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
          <div>
            <h3 class="modal-title" id="modalTitle">Detalle</h3>
            <!-- ✅ Perfil olfativo: 2-3 familias -->
            <div id="modalProfile" class="profile-row"></div>
          </div>
          <button class="modal-close" id="modalClose" type="button" aria-label="Cerrar">×</button>
        </div>

        <div class="modal-body">
          <div id="modalMeta" class="row" style="gap:8px; flex-wrap:wrap;"></div>

          <div class="label" style="margin:0;">Ingredientes usados</div>
          <div class="table-scroll" style="border:1px solid #eee; border-radius:12px;">
            <table class="ingredients-table">
              <thead>
                <tr>
                  <th>Ingrediente</th>
                  <th>Lugar</th>
                </tr>
              </thead>
              <tbody id="modalIngredients"></tbody>
            </table>
          </div>

          <div id="modalMissingHint" class="hint" style="display:none;">
            Algunos ingredientes ya no existen en tu biblioteca (fueron eliminados).
          </div>
        </div>
      </div>
    </div>

    <script>
      function normalizeText(value) {
        return (value ?? "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function escapeHtml(str) {
        return (str ?? "")
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeHtmlAttr(str) {
        return escapeHtml(str).replace(/`/g, "&#096;");
      }

      function cryptoRandomId() {
        if (window.crypto?.randomUUID) return crypto.randomUUID();
        return `id_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }

      const ESSENCES_KEY = "essences";
      const PERFUMES_KEY = "perfumes";

      function loadEssences() {
        try { return JSON.parse(localStorage.getItem(ESSENCES_KEY)) || []; }
        catch { return []; }
      }

      function loadPerfumes() {
        try { return JSON.parse(localStorage.getItem(PERFUMES_KEY)) || []; }
        catch { return []; }
      }

      function savePerfumes(perfumes) {
        localStorage.setItem(PERFUMES_KEY, JSON.stringify(perfumes));
      }

      /* ✅ Familias + colores (mismos que tu Biblioteca) */
      const FAMILY_META = {
        'Aromática': { bg: '#0F766E', fg: '#FFFFFF' },
        'Amaderada': { bg: '#7C2D12', fg: '#FFFFFF' },
        'Ambarada': { bg: '#D68F00', fg: '#111827' },
        'Almizclada': { bg: '#E3E3E3', fg: '#000000' },
        'Floral': { bg: '#EC4899', fg: '#FFFFFF' },
        'Cuero': { bg: '#3F2A1D', fg: '#FFFFFF' },
        'Oriental': { bg: '#2D0075', fg: '#FFFFFF' },
        'Especiada': { bg: '#DC2626', fg: '#FFFFFF' },
        'Balsámica': { bg: '#065F46', fg: '#FFFFFF' },
        'Resinosa': { bg: '#92400E', fg: '#FFFFFF' },
        'Frutal': { bg: '#FB7185', fg: '#111827' },
        'Gourmand': { bg: '#6B21A8', fg: '#FFFFFF' },
        'Herbal': { bg: '#16A34A', fg: '#FFFFFF' },
        'Verde': { bg: '#96D99A', fg: '#111827' },
        'Aldehídica': { bg: '#0EA5E9', fg: '#FFFFFF' },
        'Animalic': { bg: '#A16207', fg: '#FFFFFF' },
        'Acuática': { bg: '#0369A1', fg: '#FFFFFF' },
        'Ozónica': { bg: '#E0F2FE', fg: '#0F172A' },
        'Terrosa': { bg: '#78350F', fg: '#FFFFFF' },
        'Empolvada': { bg: '#E9D5FF', fg: '#4C1D95' },
        'Ahumada': { bg: '#374151', fg: '#FFFFFF' },
        'Metálica': { bg: '#9CA3AF', fg: '#111827' },
        'Licorosa': { bg: '#BE185D', fg: '#FFFFFF' },
        'Lactónica': { bg: '#FEF3C7', fg: '#7C2D12' },
        'Anisada': { bg: '#2DD4BF', fg: '#0F172A' },
        'Cítrica': { bg: '#F7FF5C', fg: '#111827' },
        'Dulce': { bg: '#E8D373', fg: '#7C2D12' },
        'Mielada': { bg: '#FFD000', fg: '#FFFFFF' },
      };

      function getFamilyStyle(family) {
        const meta = FAMILY_META[family] || { bg: "#EEE", fg: "#111" };
        return `background:${meta.bg};color:${meta.fg};border:1px solid rgba(0,0,0,.08);`;
      }

      /* ✅ PERFIL: calcula 2-3 familias dominantes del perfume */
      function noteWeight(notes) {
        const s = new Set((notes ?? []).map(n => normalizeText(n)));
        if (s.has("corazon") || s.has("corazón")) return 1.5;
        if (s.has("fondo")) return 1.3;
        if (s.has("salida")) return 1.2;
        return 1.0;
      }

      function computePerfumeProfileFamilies(ingredientIds, essencesById) {
        const score = new Map();   // family -> number
        const freq = new Map();    // family -> ingredients count

        for (const id of (ingredientIds ?? [])) {
          const ing = essencesById.get(id);
          if (!ing) continue;

          const families = Array.isArray(ing.families) ? ing.families.filter(Boolean) : [];
          if (families.length === 0) continue;

          const w = noteWeight(ing.notes);
          const perFamily = w / families.length; // evita “spam” por multi-familia

          for (const fam of families) {
            score.set(fam, (score.get(fam) ?? 0) + perFamily);
            freq.set(fam, (freq.get(fam) ?? 0) + 1);
          }
        }

        const items = [...score.entries()].map(([family, sc]) => ({
          family,
          score: sc,
          freq: freq.get(family) ?? 0,
        }));

        items.sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          if (b.freq !== a.freq) return b.freq - a.freq;
          return normalizeText(a.family).localeCompare(normalizeText(b.family));
        });

        if (items.length === 0) return [];

        const top1 = items[0].score;
        const selected = [items[0].family];

        if (items[1] && items[1].score >= top1 * 0.55) selected.push(items[1].family);
        if (items[2] && items[2].score >= top1 * 0.70) selected.push(items[2].family);

        return selected.slice(0, 3);
      }

      let essences = loadEssences();
      let perfumes = loadPerfumes();

      const selectedIngredientIds = new Set();

      const perfumeNameInput = document.getElementById("perfumeName");
      const ingredientSearch = document.getElementById("ingredientSearch");
      const ingredientSuggest = document.getElementById("ingredientSuggest");
      const selectedChips = document.getElementById("selectedChips");
      const savePerfumeBtn = document.getElementById("savePerfumeBtn");

      const perfumesGrid = document.getElementById("perfumesGrid");

      const modalOverlay = document.getElementById("modalOverlay");
      const modalClose = document.getElementById("modalClose");
      const modalTitle = document.getElementById("modalTitle");
      const modalProfile = document.getElementById("modalProfile");
      const modalMeta = document.getElementById("modalMeta");
      const modalIngredients = document.getElementById("modalIngredients");
      const modalMissingHint = document.getElementById("modalMissingHint");

      function openSuggest() { ingredientSuggest.classList.add("open"); }
      function closeSuggest() { ingredientSuggest.classList.remove("open"); }

      function getStockTextClass(stock) {
        if (stock === "low") return "stock-text-low";
        if (stock === "out") return "stock-text-out";
        return "stock-text-available";
      }

      function formatPlaceWithId(e) {
        const place = (e?.place ?? "").toString().trim() || "—";
        const localId = Number(e?.localId);
        if (Number.isFinite(localId) && localId > 0) return `${place} (#${localId})`;
        return place;
      }

      function essenceLabel(e) {
        const idTxt = e.localId ? `#${e.localId}` : "";
        const place = e.place ? ` • ${e.place}` : "";
        return `${e.name} ${idTxt}${place}`.trim();
      }

      function getEssenceById(id) {
        return essences.find((e) => e.id === id) || null;
      }

      function renderSuggest() {
        essences = loadEssences();
        const q = normalizeText(ingredientSearch.value.trim());

        let list = essences;
        if (q) {
          list = essences.filter((e) => {
            const hay = `${e.name} ${e.place ?? ""} ${e.provider ?? ""}`.trim();
            return normalizeText(hay).includes(q);
          });
        }

        list = list.slice(0, 20);

        if (list.length === 0) {
          ingredientSuggest.innerHTML = `<div class="suggest-empty">Sin resultados</div>`;
          return;
        }

        ingredientSuggest.innerHTML = list
          .map((e) => {
            const disabled = selectedIngredientIds.has(e.id);
            const stockClass = getStockTextClass(e.stock);
            return `
              <div class="suggest-item" data-id="${escapeHtmlAttr(e.id)}" style="${disabled ? "opacity:.45;pointer-events:none;" : ""}">
                <span class="${stockClass}">${escapeHtml(essenceLabel(e))}</span>
              </div>
            `;
          })
          .join("");
      }

      ingredientSearch.addEventListener("focus", () => {
        renderSuggest();
        openSuggest();
      });

      ingredientSearch.addEventListener("input", () => {
        renderSuggest();
        openSuggest();
      });

      ingredientSuggest.addEventListener("click", (e) => {
        const item = e.target.closest(".suggest-item");
        if (!item) return;
        const id = item.dataset.id;
        if (!id) return;

        selectedIngredientIds.add(id);
        ingredientSearch.value = "";
        closeSuggest();
        renderSelectedChips();
      });

      function renderSelectedChips() {
        selectedChips.innerHTML = "";
        const ids = [...selectedIngredientIds];

        if (ids.length === 0) {
          selectedChips.innerHTML = `<div class="hint">No agregaste ingredientes todavía.</div>`;
          return;
        }

        for (const id of ids) {
          const e = getEssenceById(id);
          const name = e?.name ?? "Ingrediente eliminado";
          const placeWithId = e ? formatPlaceWithId(e) : "—";
          const stockClass = e ? getStockTextClass(e.stock) : "stock-text-available";

          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `
            <span class="${stockClass}">${escapeHtml(name)}</span>
            <span class="muted">${escapeHtml(placeWithId)}</span>
            <span class="x" title="Quitar" aria-label="Quitar">×</span>
          `;

          chip.querySelector(".x")?.addEventListener("click", () => {
            selectedIngredientIds.delete(id);
            renderSelectedChips();
          });

          selectedChips.appendChild(chip);
        }
      }

      savePerfumeBtn.addEventListener("click", () => {
        const name = perfumeNameInput.value.trim();
        const ingredients = [...selectedIngredientIds];

        if (!name) { alert("Escribí el nombre del perfume."); return; }
        if (ingredients.length === 0) { alert("Agregá al menos 1 ingrediente."); return; }

        const key = normalizeText(name);
        const exists = perfumes.some((p) => normalizeText(p.name) === key);
        if (exists) {
          const ok = confirm("Ya existe un perfume con ese nombre. ¿Querés reemplazarlo?");
          if (!ok) return;
          perfumes = perfumes.filter((p) => normalizeText(p.name) !== key);
        }

        perfumes.push({
          id: cryptoRandomId(),
          name,
          ingredientIds: ingredients,
          createdAt: new Date().toISOString(),
        });

        savePerfumeBtn.textContent = "Guardado ✅";
        setTimeout(() => (savePerfumeBtn.textContent = "Guardar perfume"), 900);

        savePerfumes(perfumes);

        perfumeNameInput.value = "";
        selectedIngredientIds.clear();
        renderSelectedChips();
        renderPerfumesTable();
      });

      function renderPerfumesTable() {
        perfumes = loadPerfumes();
        perfumes = [...perfumes].sort((a, b) =>
          normalizeText(a.name).localeCompare(normalizeText(b.name))
        );

        perfumesGrid.innerHTML = "";

        if (perfumes.length === 0) {
          perfumesGrid.innerHTML =
            `<tr><td colspan="3" style="color:#666;font-style:italic;">No hay perfumes guardados.</td></tr>`;
          return;
        }

        for (const p of perfumes) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="name-link" data-action="open" data-id="${escapeHtmlAttr(p.id)}">${escapeHtml(p.name)}</span></td>
            <td>${p.ingredientIds?.length ?? 0}</td>
            <td>
              <button class="tool-btn danger" data-action="delete" data-id="${escapeHtmlAttr(p.id)}" type="button">Eliminar</button>
            </td>
          `;
          perfumesGrid.appendChild(tr);
        }
      }

      perfumesGrid.addEventListener("click", (e) => {
        const openEl = e.target.closest('[data-action="open"]');
        if (openEl) {
          const id = openEl.dataset.id;
          if (id) openPerfumeModal(id);
          return;
        }

        const delBtn = e.target.closest('button[data-action="delete"]');
        if (delBtn) {
          const id = delBtn.dataset.id;
          if (!id) return;
          const ok = confirm("¿Eliminar este perfume?");
          if (!ok) return;
          perfumes = loadPerfumes().filter((p) => p.id !== id);
          savePerfumes(perfumes);
          renderPerfumesTable();
        }
      });

      function renderProfileBadges(families) {
        modalProfile.innerHTML = "";
        if (!families || families.length === 0) return;

        for (const fam of families) {
          const b = document.createElement("span");
          b.className = "profile-badge";
          b.style.cssText = getFamilyStyle(fam);
          b.textContent = fam;
          modalProfile.appendChild(b);
        }
      }

      function openPerfumeModal(id) {
        essences = loadEssences();
        perfumes = loadPerfumes();

        const perfume = perfumes.find((p) => p.id === id);
        if (!perfume) return;

        modalTitle.textContent = perfume.name;

        // ✅ map por id para cálculo rápido
        const essencesById = new Map(essences.map(e => [e.id, e]));

        // ✅ perfil 2-3 familias dominantes
        const profileFamilies = computePerfumeProfileFamilies(perfume.ingredientIds, essencesById);
        renderProfileBadges(profileFamilies);

        modalMeta.innerHTML = "";
        modalMeta.appendChild(makePill(`Ingredientes: ${perfume.ingredientIds?.length ?? 0}`));
        modalMeta.appendChild(makePill(`Guardado: ${new Date(perfume.createdAt).toLocaleDateString()}`));

        modalIngredients.innerHTML = "";
        modalMissingHint.style.display = "none";

        let missing = 0;

        for (const ingId of perfume.ingredientIds || []) {
          const e = essencesById.get(ingId) || null;
          if (!e) missing += 1;

          const name = e?.name ?? "Ingrediente eliminado";
          const placeWithId = e ? formatPlaceWithId(e) : "—";
          const stockClass = e ? getStockTextClass(e.stock) : "stock-text-available";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="${stockClass}">${escapeHtml(name)}</td>
            <td title="${escapeHtmlAttr(placeWithId)}">${escapeHtml(placeWithId)}</td>
          `;
          modalIngredients.appendChild(tr);
        }

        if (missing > 0) modalMissingHint.style.display = "block";

        modalOverlay.classList.add("open");
        modalOverlay.setAttribute("aria-hidden", "false");
        modalClose.focus();
      }

      function makePill(text) {
        const s = document.createElement("span");
        s.className = "pill";
        s.textContent = text;
        return s;
      }

      function closeModal() {
        modalOverlay.classList.remove("open");
        modalOverlay.setAttribute("aria-hidden", "true");
      }

      modalClose.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      document.addEventListener("click", (e) => {
        const wrap = ingredientSearch.closest(".suggest-wrap");
        if (wrap && !wrap.contains(e.target)) closeSuggest();
      });

      window.addEventListener("DOMContentLoaded", () => {
        renderSelectedChips();
        renderPerfumesTable();
      });
    </script>
  </body>
</html>
